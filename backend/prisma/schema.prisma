// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

model User {
  userId        String                     @id @default(uuid())
  email         String                     @unique
  password      String
  firstName     String
  lastName      String
  phoneNumber   String
  nic           String
  address       String?
  station       Station?                   @relation(fields: [stationId], references: [stationId])
  role          Role                       @default(PASSENGER)
  stationId     String?
  initialLogIn  Boolean                    @default(true)
  status        Status                     @default(ACTIVE)
  ReasonToBlock ReasonToBlock[]
  Complaints    ComplaintsAndSuggestions[]
  Ticket        Ticket[]
}

enum Role {
  ADMIN
  PASSENGER
  CONTROL_OFFICER
  TICKETING_OFFICER
  TICKET_CHECKER
}

enum Status {
  ACTIVE
  BANNED
}

model Station {
  stationId           String                @id
  name                String
  address             String
  phoneNumber         String
  location            String
  adjacentTo          Station[]             @relation("AdjacentStations")
  adjacentFrom        Station[]             @relation("AdjacentStations")
  User                User[]
  CrewMember          CrewMember[]
  IntermediateStation IntermediateStation[]
  StartStationTicket  Ticket[]              @relation("startStation")
  DestStationTicket   Ticket[]              @relation("destStation")
}

model CrewMember {
  userId      String     @id @default(uuid())
  firstName   String
  lastName    String
  phoneNumber String
  nic         String     @unique
  address     String?
  station     Station    @relation(fields: [stationId], references: [stationId])
  occupation  Occupation
  stationId   String
  visibility  Visibility @default(VISIBLE)
}

enum Occupation {
  DRIVER
  DRIVER_ASSISTANT
  HEAD_GUARD
  UNDER_GUARD
}

enum Visibility {
  HIDDEN
  VISIBLE
}

model ReasonToBlock {
  userId String @id
  user   User   @relation(fields: [userId], references: [userId])
  reason String
}

model TrainTurn {
  turnNumber           Int                   @id
  turnName             String
  reservable           Boolean
  availability         TrainTurnAvailability @default(DAILY)
  type                 TrainTurnType         @default(SLOW)
  intermediateStations IntermediateStation[]
  trainCompartments    TrainCompartment[]
}

model TrainCompartment {
  trainTurn         TrainTurn             @relation(fields: [turnNumber], references: [turnNumber])
  turnNumber        Int
  compartmentNumber String
  seatCount         Int
  class             TrainReservationClass @default(THIRD_CLASS)

  @@id([turnNumber, compartmentNumber])
}

model IntermediateStation {
  stationId     String
  station       Station   @relation(fields: [stationId], references: [stationId])
  arrivalTime   String?
  departureTime String?
  isStart       Boolean
  isEnd         Boolean
  trainTurn     TrainTurn @relation(fields: [turnNumber], references: [turnNumber])
  turnNumber    Int

  @@id([turnNumber, stationId])
}

enum TrainTurnAvailability {
  SO
  NS
  NSU
  DAILY
}

enum TrainTurnType {
  SLOW
  EXPRESS
  INTERCITY
}

model Ticket {
  ticketId        String                @id @default(uuid())
  user            User?                 @relation(fields: [userId], references: [userId])
  userId          String?
  ticketClass     TrainReservationClass
  startingStation Station               @relation("startStation", fields: [startStationId], references: [stationId])
  destination     Station               @relation("destStation", fields: [destStationId], references: [stationId])
  status          TicketStatus
  email           String?
  issuedOn        DateTime              @default(now())
  startStationId  String
  destStationId   String
  price           Decimal
  NormalTicket    NormalTicket?
  ReserveTicket   ReserveTicket?
  SeasonTicket    SeasonTicket?
}

model NormalTicket {
  ticket       Ticket  @relation(fields: [ticketId], references: [ticketId])
  returnStatus Boolean
  ticketId     String  @id
}

model ReserveTicket {
  ticket           Ticket          @relation(fields: [ticketId], references: [ticketId])
  ticketId         String          @id
  turnNumber       String
  noOfSeats        Int
  primaryPassenger String
  date             DateTime
  ReservedSeats    ReservedSeats[]
}

model ReservedSeats {
  ticket          ReserveTicket @relation(fields: [reserveTicketId], references: [ticketId])
  reserveTicketId String
  seatNo          String
  NIC             String        @unique
}

model SeasonTicket {
  ticket         Ticket   @relation(fields: [ticketId], references: [ticketId])
  ticketId       String   @id
  passenngerName String
  expirationDate DateTime
}

enum TrainReservationClass {
  FIRST_CLASS
  SECOND_CLASS
  THIRD_CLASS
}

model ComplaintsAndSuggestions {
  complaintId String   @id @default(uuid())
  userId      String
  user        User     @relation(fields: [userId], references: [userId])
  createdAt   DateTime @default(now())
  title       String
  description String
  isComplaint Boolean
}

enum TicketStatus {
  USED
  UNUSED
}
